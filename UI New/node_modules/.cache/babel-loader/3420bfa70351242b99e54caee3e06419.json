{"ast":null,"code":"import React, { useRef, useContext, useState, useReducer, useEffect, createContext } from 'react';\nimport AgoraRTC, { createClient, AgoraVideoPlayer, createMicrophoneAndCameraTracks } from 'agora-rtc-react';\nimport AgoraRTM, { createLazyChannel, createLazyClient } from 'agora-rtm-react';\nfunction _extends() {\n  _extends = Object.assign || function (target) {\n    for (var i = 1; i < arguments.length; i++) {\n      var source = arguments[i];\n      for (var key in source) {\n        if (Object.prototype.hasOwnProperty.call(source, key)) {\n          target[key] = source[key];\n        }\n      }\n    }\n    return target;\n  };\n  return _extends.apply(this, arguments);\n}\n\n// A type of promise-like that resolves synchronously and supports only one observer\n\nvar _iteratorSymbol = /*#__PURE__*/typeof Symbol !== \"undefined\" ? Symbol.iterator || (Symbol.iterator = Symbol(\"Symbol.iterator\")) : \"@@iterator\";\nvar _asyncIteratorSymbol = /*#__PURE__*/typeof Symbol !== \"undefined\" ? Symbol.asyncIterator || (Symbol.asyncIterator = Symbol(\"Symbol.asyncIterator\")) : \"@@asyncIterator\";\n\n// Asynchronously call a function and send errors to recovery continuation\nfunction _catch(body, recover) {\n  try {\n    var result = body();\n  } catch (e) {\n    return recover(e);\n  }\n  if (result && result.then) {\n    return result.then(void 0, recover);\n  }\n  return result;\n}\nvar RtcContext = React.createContext({});\nvar RtcProvider = RtcContext.Provider;\nvar RtcConsumer = RtcContext.Consumer;\nvar remoteTrackState;\n(function (remoteTrackState) {\n  remoteTrackState[remoteTrackState[\"yes\"] = 0] = \"yes\";\n  remoteTrackState[remoteTrackState[\"subbed\"] = 1] = \"subbed\";\n  remoteTrackState[remoteTrackState[\"no\"] = 2] = \"no\";\n})(remoteTrackState || (remoteTrackState = {}));\nvar layout;\n(function (layout) {\n  layout[layout[\"grid\"] = 0] = \"grid\";\n  layout[layout[\"pin\"] = 1] = \"pin\";\n})(layout || (layout = {}));\nvar ToggleState;\n(function (ToggleState) {\n  ToggleState[ToggleState[\"disabled\"] = 0] = \"disabled\";\n  ToggleState[ToggleState[\"enabled\"] = 1] = \"enabled\";\n  ToggleState[ToggleState[\"disabling\"] = 2] = \"disabling\";\n  ToggleState[ToggleState[\"enabling\"] = 3] = \"enabling\";\n})(ToggleState || (ToggleState = {}));\nvar initialValue = {\n  rtcProps: {\n    appId: '',\n    channel: '',\n    role: 'host'\n  },\n  rtmProps: {}\n};\nvar PropsContext = React.createContext(initialValue);\nvar PropsProvider = PropsContext.Provider;\nvar MaxUidContext = React.createContext([]);\nvar MaxUidProvider = MaxUidContext.Provider;\nvar MaxUidConsumer = MaxUidContext.Consumer;\nvar MinUidContext = React.createContext([]);\nvar MinUidProvider = MinUidContext.Provider;\nvar MinUidConsumer = MinUidContext.Consumer;\nvar TracksContext = React.createContext({});\nvar TracksProvider = TracksContext.Provider;\nvar initState = {\n  max: [{\n    uid: 0,\n    hasAudio: remoteTrackState.no,\n    hasVideo: remoteTrackState.no\n  }],\n  min: [],\n  isScreensharing: false\n};\nvar reducer = function reducer(state, action) {\n  var stateUpdate = initState;\n  var uids = [].concat(state.max, state.min).map(function (u) {\n    return u.uid;\n  });\n  switch (action.type) {\n    case 'Screensharing':\n      {\n        stateUpdate = _extends({}, state, {\n          isScreensharing: action.value[0]\n        });\n        console.log('!Screensharingstate', state, stateUpdate);\n      }\n      break;\n    case 'update-user-video':\n      {\n        stateUpdate = {\n          min: state.min.map(function (user) {\n            if (user.uid === 0) {\n              return {\n                uid: 0,\n                hasAudio: remoteTrackState.subbed,\n                hasVideo: remoteTrackState.subbed\n              };\n            } else {\n              return user;\n            }\n          }),\n          max: state.max.map(function (user) {\n            if (user.uid === 0) {\n              return {\n                uid: 0,\n                hasAudio: remoteTrackState.subbed,\n                hasVideo: remoteTrackState.subbed\n              };\n            } else {\n              return user;\n            }\n          }),\n          isScreensharing: state.isScreensharing\n        };\n      }\n      break;\n    case 'user-joined':\n      {\n        if (uids.indexOf(action.value[0].uid) === -1) {\n          var minUpdate = [].concat(state.min, [{\n            uid: action.value[0].uid,\n            hasAudio: remoteTrackState.no,\n            hasVideo: remoteTrackState.no\n          }]);\n          if (minUpdate.length === 1 && state.max[0].uid === 0) {\n            stateUpdate = {\n              max: minUpdate,\n              min: state.max,\n              isScreensharing: state.isScreensharing\n            };\n          } else {\n            stateUpdate = {\n              min: minUpdate,\n              max: state.max,\n              isScreensharing: state.isScreensharing\n            };\n          }\n        }\n      }\n      break;\n    case 'user-unpublished':\n      {\n        if (state.max[0].uid === action.value[0].uid) {\n          stateUpdate = {\n            max: [{\n              uid: action.value[0].uid,\n              hasAudio: action.value[1] === 'audio' ? remoteTrackState.no : state.max[0].hasAudio,\n              hasVideo: action.value[1] === 'video' ? remoteTrackState.no : state.max[0].hasVideo\n            }],\n            min: state.min,\n            isScreensharing: state.isScreensharing\n          };\n        } else {\n          var UIKitUser = state.min.find(function (user) {\n            return user.uid === action.value[0].uid;\n          });\n          if (UIKitUser) {\n            var _minUpdate = [].concat(state.min.filter(function (user) {\n              return user.uid !== action.value[0].uid;\n            }), [{\n              uid: action.value[0].uid,\n              hasAudio: action.value[1] === 'audio' ? remoteTrackState.no : UIKitUser.hasAudio,\n              hasVideo: action.value[1] === 'video' ? remoteTrackState.no : UIKitUser.hasVideo\n            }]);\n            stateUpdate = {\n              min: _minUpdate,\n              max: state.max,\n              isScreensharing: state.isScreensharing\n            };\n          }\n        }\n      }\n      break;\n    case 'user-published':\n      {\n        if (state.max[0].uid === action.value[0].uid) {\n          stateUpdate = {\n            max: [{\n              uid: action.value[0].uid,\n              hasAudio: action.value[1] === 'audio' ? remoteTrackState.subbed : state.max[0].hasAudio,\n              hasVideo: action.value[1] === 'video' ? remoteTrackState.subbed : state.max[0].hasVideo\n            }],\n            min: state.min,\n            isScreensharing: state.isScreensharing\n          };\n        } else {\n          stateUpdate = {\n            min: state.min.map(function (user) {\n              if (user.uid !== action.value[0].uid) {\n                return user;\n              } else {\n                return {\n                  uid: user.uid,\n                  hasAudio: action.value[1] === 'audio' ? remoteTrackState.subbed : user.hasAudio,\n                  hasVideo: action.value[1] === 'video' ? remoteTrackState.subbed : user.hasVideo\n                };\n              }\n            }),\n            max: state.max,\n            isScreensharing: state.isScreensharing\n          };\n        }\n      }\n      break;\n    case 'user-left':\n      {\n        if (state.max[0].uid === action.value[0].uid) {\n          var _minUpdate2 = [].concat(state.min);\n          stateUpdate = {\n            max: [_minUpdate2.pop()],\n            min: _minUpdate2,\n            isScreensharing: state.isScreensharing\n          };\n        } else {\n          stateUpdate = {\n            min: state.min.filter(function (user) {\n              return user.uid !== action.value[0].uid;\n            }),\n            max: state.max,\n            isScreensharing: state.isScreensharing\n          };\n        }\n      }\n      break;\n    case 'user-swap':\n      {\n        if (state.max[0].uid === action.value[0].uid) ;else {\n          stateUpdate = {\n            max: [action.value[0]],\n            min: [].concat(state.min.filter(function (user) {\n              return user.uid !== action.value[0].uid;\n            }), [state.max[0]]),\n            isScreensharing: state.isScreensharing\n          };\n        }\n      }\n      break;\n    case 'local-user-mute-video':\n      {\n        stateUpdate = {\n          min: state.min.map(function (user) {\n            if (user.uid === 0) {\n              return {\n                uid: 0,\n                hasAudio: user.hasAudio,\n                hasVideo: action.value[0]\n              };\n            } else {\n              return user;\n            }\n          }),\n          max: state.max.map(function (user) {\n            if (user.uid === 0) {\n              return {\n                uid: 0,\n                hasAudio: user.hasAudio,\n                hasVideo: action.value[0]\n              };\n            } else {\n              return user;\n            }\n          }),\n          isScreensharing: state.isScreensharing\n        };\n      }\n      break;\n    case 'local-user-mute-audio':\n      {\n        stateUpdate = {\n          min: state.min.map(function (user) {\n            if (user.uid === 0) {\n              return {\n                uid: 0,\n                hasAudio: action.value[0],\n                hasVideo: user.hasVideo\n              };\n            } else {\n              return user;\n            }\n          }),\n          max: state.max.map(function (user) {\n            if (user.uid === 0) {\n              return {\n                uid: 0,\n                hasAudio: action.value[0],\n                hasVideo: user.hasVideo\n              };\n            } else {\n              return user;\n            }\n          }),\n          isScreensharing: state.isScreensharing\n        };\n      }\n      break;\n    case 'remote-user-mute-video':\n      {\n        stateUpdate = {\n          min: state.min.map(function (user) {\n            if (user.uid === action.value[0].uid) {\n              return {\n                uid: user.uid,\n                hasVideo: action.value[1],\n                hasAudio: user.hasAudio\n              };\n            } else return user;\n          }),\n          max: state.max.map(function (user) {\n            if (user.uid === action.value[0].uid) return {\n              uid: user.uid,\n              hasVideo: action.value[1],\n              hasAudio: user.hasAudio\n            };else return user;\n          }),\n          isScreensharing: state.isScreensharing\n        };\n      }\n      break;\n    case 'remote-user-mute-audio':\n      {\n        stateUpdate = {\n          min: state.min.map(function (user) {\n            if (user.uid === action.value[0].uid) return {\n              uid: user.uid,\n              hasAudio: action.value[1],\n              hasVideo: user.hasVideo\n            };else return user;\n          }),\n          max: state.max.map(function (user) {\n            if (user.uid === action.value[0].uid) return {\n              uid: user.uid,\n              hasAudio: action.value[1],\n              hasVideo: user.hasVideo\n            };else return user;\n          }),\n          isScreensharing: state.isScreensharing\n        };\n      }\n      break;\n    case 'leave-channel':\n      stateUpdate = initState;\n      break;\n    case 'ActiveSpeaker':\n      {\n        if (state.max[0].uid === action.value[0]) {\n          stateUpdate = _extends({}, state);\n        } else {\n          stateUpdate = {\n            max: [state.min.find(function (user) {\n              return user.uid === action.value[0];\n            })],\n            min: [].concat(state.min.filter(function (user) {\n              return user.uid !== action.value[0];\n            }), [state.max[0]]),\n            isScreensharing: state.isScreensharing\n          };\n        }\n      }\n      break;\n  }\n  console.log('!state-update', _extends({}, state, stateUpdate), stateUpdate);\n  return _extends({}, state, stateUpdate);\n};\nvar startScreenshare = function startScreenshare(appId, channel, track, screenshareToken, screenshareUid, tokenUrl, enableDualStream) {\n  try {\n    var init = function init() {\n      try {\n        try {\n          console.log(screenClient);\n          if (tokenUrl) {\n            screenClient.on('token-privilege-will-expire', function () {\n              try {\n                console.log('token will expire');\n                return Promise.resolve(fetch(tokenUrl + '/rtc/' + channel + '/publisher/uid/' + uid + '/')).then(function (res) {\n                  return Promise.resolve(res.json()).then(function (data) {\n                    var token = data.rtcToken;\n                    screenClient.renewToken(token);\n                  });\n                });\n              } catch (e) {\n                return Promise.reject(e);\n              }\n            });\n            screenClient.on('token-privilege-did-expire', function () {\n              try {\n                return Promise.resolve(fetch(tokenUrl + '/rtc/' + channel + '/publisher/uid/' + uid + '/')).then(function (res) {\n                  return Promise.resolve(res.json()).then(function (data) {\n                    var token = data.rtcToken;\n                    screenClient.renewToken(token);\n                  });\n                });\n              } catch (e) {\n                return Promise.reject(e);\n              }\n            });\n          }\n          track.on('track-ended', function () {\n            screenClient.leave();\n            screenClient.removeAllListeners();\n          });\n        } catch (e) {\n          console.log(e);\n        }\n        return Promise.resolve();\n      } catch (e) {\n        return Promise.reject(e);\n      }\n    };\n    var join = function join() {\n      try {\n        screenClient.setClientRole('host');\n        var _temp3 = function () {\n          if (tokenUrl) {\n            var _temp4 = _catch(function () {\n              return Promise.resolve(fetch(tokenUrl + '/rtc/' + channel + '/publisher/uid/' + uid + '/')).then(function (res) {\n                return Promise.resolve(res.json()).then(function (data) {\n                  var token = data.rtcToken;\n                  return Promise.resolve(screenClient.join(appId, channel, token, uid)).then(function (_screenClient$join) {\n                    returnedUid = _screenClient$join;\n                  });\n                });\n              });\n            }, function (e) {\n              console.log(e);\n            });\n            if (_temp4 && _temp4.then) return _temp4.then(function () {});\n          } else {\n            return Promise.resolve(screenClient.join(appId, channel, screenshareToken || null, uid || 0)).then(function (_screenClient$join2) {\n              returnedUid = _screenClient$join2;\n            });\n          }\n        }();\n        return Promise.resolve(_temp3 && _temp3.then ? _temp3.then(function () {}) : void 0);\n      } catch (e) {\n        return Promise.reject(e);\n      }\n    };\n    var publish = function publish() {\n      try {\n        var _temp10 = function _temp10() {\n          var _temp6 = function () {\n            if (track.enabled) {\n              var _temp9 = function () {\n                if (!localVideoTrackHasPublished) {\n                  return Promise.resolve(screenClient.publish([track]).then(function () {\n                    localVideoTrackHasPublished = true;\n                  })).then(function () {});\n                }\n              }();\n              if (_temp9 && _temp9.then) return _temp9.then(function () {});\n            }\n          }();\n          if (_temp6 && _temp6.then) return _temp6.then(function () {});\n        };\n        var _temp11 = function () {\n          if (enableDualStream) {\n            return Promise.resolve(screenClient.enableDualStream()).then(function () {});\n          }\n        }();\n        return Promise.resolve(_temp11 && _temp11.then ? _temp11.then(_temp10) : _temp10(_temp11));\n      } catch (e) {\n        return Promise.reject(e);\n      }\n    };\n    var screenClient = AgoraRTC.createClient({\n      mode: 'live',\n      role: 'host',\n      codec: 'vp8'\n    });\n    var returnedUid = 0;\n    var uid = screenshareUid || 1;\n    var localVideoTrackHasPublished = false;\n    var stop = function stop() {\n      try {\n        var _temp13 = _catch(function () {\n          track.close();\n          return Promise.resolve(screenClient.leave()).then(function () {\n            screenClient.removeAllListeners();\n          });\n        }, function (e) {\n          console.log(e);\n        });\n        return Promise.resolve(_temp13 && _temp13.then ? _temp13.then(function () {}) : void 0);\n      } catch (e) {\n        return Promise.reject(e);\n      }\n    };\n    stopScreenshare = stop;\n    return Promise.resolve(init()).then(function () {\n      return Promise.resolve(join()).then(function () {\n        return Promise.resolve(publish()).then(function () {\n          if (returnedUid) console.log(returnedUid);\n        });\n      });\n    });\n  } catch (e) {\n    return Promise.reject(e);\n  }\n};\nvar stopScreenshare = function stopScreenshare() {};\nvar useClient = createClient({\n  codec: 'vp8',\n  mode: 'live'\n});\nvar RtcConfigure = function RtcConfigure(props) {\n  var uid = useRef();\n  var screenTrack = useRef();\n  var isScreensharingRef = useRef(false);\n  var _useContext = useContext(TracksContext),\n    localVideoTrack = _useContext.localVideoTrack,\n    localAudioTrack = _useContext.localAudioTrack;\n  var _useContext2 = useContext(PropsContext),\n    callbacks = _useContext2.callbacks,\n    rtcProps = _useContext2.rtcProps;\n  var _useState = useState(false),\n    ready = _useState[0],\n    setReady = _useState[1];\n  var _useState2 = useState(false),\n    channelJoined = _useState2[0],\n    setChannelJoined = _useState2[1];\n  var joinRes = null;\n  var canJoin = useRef(new Promise(function (resolve, reject) {\n    joinRes = resolve;\n    console.log(reject);\n  }));\n  var client = useClient();\n  if (rtcProps.customRtcClient) {\n    client.removeAllListeners();\n    client = rtcProps.customRtcClient;\n  }\n  var localVideoTrackHasPublished = false;\n  var localAudioTrackHasPublished = false;\n  var mediaStore = useRef({});\n  var callActive = props.callActive;\n  if (callActive === undefined) {\n    callActive = true;\n  }\n  var _useReducer = useReducer(reducer, initState),\n    uidState = _useReducer[0],\n    dispatch = _useReducer[1];\n  useEffect(function () {\n    var init = function init() {\n      try {\n        try {\n          console.log(client);\n          client.on('user-joined', function () {\n            try {\n              for (var _len = arguments.length, args = new Array(_len), _key = 0; _key < _len; _key++) {\n                args[_key] = arguments[_key];\n              }\n              var remoteUser = args[0];\n              if (remoteUser.uid === props.screenshareUid && isScreensharingRef.current || remoteUser.uid === 1 && isScreensharingRef.current) {} else {\n                mediaStore.current[remoteUser.uid] = {};\n              }\n              dispatch({\n                type: 'user-joined',\n                value: args\n              });\n              return Promise.resolve();\n            } catch (e) {\n              return Promise.reject(e);\n            }\n          });\n          client.on('user-published', function () {\n            for (var _len2 = arguments.length, args = new Array(_len2), _key2 = 0; _key2 < _len2; _key2++) {\n              args[_key2] = arguments[_key2];\n            }\n            try {\n              var remoteUser = args[0],\n                mediaType = args[1];\n              console.log('user-published', remoteUser.uid);\n              if (remoteUser.uid === props.screenshareUid && isScreensharingRef.current || remoteUser.uid === 1 && isScreensharingRef.current) {\n                dispatch({\n                  type: 'user-published',\n                  value: args\n                });\n              } else {\n                client.subscribe(remoteUser, mediaType).then(function (_e) {\n                  mediaStore.current[remoteUser.uid][mediaType + 'Track'] = remoteUser[mediaType + 'Track'];\n                  if (mediaType === 'audio') {\n                    var _remoteUser$audioTrac;\n                    (_remoteUser$audioTrac = remoteUser.audioTrack) === null || _remoteUser$audioTrac === void 0 ? void 0 : _remoteUser$audioTrac.play();\n                  } else {\n                    if (rtcProps.enableDualStream && rtcProps.dualStreamMode) {\n                      client.setStreamFallbackOption(remoteUser.uid, rtcProps.dualStreamMode);\n                    }\n                  }\n                  dispatch({\n                    type: 'user-published',\n                    value: args\n                  });\n                })[\"catch\"](function (e) {\n                  return console.log(e);\n                });\n              }\n              return Promise.resolve();\n            } catch (e) {\n              return Promise.reject(e);\n            }\n          });\n          client.on('user-unpublished', function () {\n            try {\n              for (var _len3 = arguments.length, args = new Array(_len3), _key3 = 0; _key3 < _len3; _key3++) {\n                args[_key3] = arguments[_key3];\n              }\n              var remoteUser = args[0],\n                mediaType = args[1];\n              console.log('user-unpublished', remoteUser.uid);\n              if (mediaType === 'audio') {\n                var _remoteUser$audioTrac2;\n                (_remoteUser$audioTrac2 = remoteUser.audioTrack) === null || _remoteUser$audioTrac2 === void 0 ? void 0 : _remoteUser$audioTrac2.stop();\n              }\n              dispatch({\n                type: 'user-unpublished',\n                value: args\n              });\n              return Promise.resolve();\n            } catch (e) {\n              return Promise.reject(e);\n            }\n          });\n          client.on('connection-state-change', function () {\n            try {\n              for (var _len4 = arguments.length, args = new Array(_len4), _key4 = 0; _key4 < _len4; _key4++) {\n                args[_key4] = arguments[_key4];\n              }\n              var curState = args[0],\n                prevState = args[1],\n                reason = args[2];\n              console.log('connection', prevState, curState, reason);\n              if (curState === 'CONNECTED') {\n                setChannelJoined(true);\n              } else if (curState === 'DISCONNECTED') {\n                try {\n                  stopScreenshare();\n                  isScreensharingRef.current = false;\n                } catch (e) {\n                  console.log('stopscreenshare', e);\n                }\n                dispatch({\n                  type: 'leave-channel',\n                  value: null\n                });\n              } else {\n                setChannelJoined(false);\n              }\n              return Promise.resolve();\n            } catch (e) {\n              return Promise.reject(e);\n            }\n          });\n          client.on('user-left', function () {\n            for (var _len5 = arguments.length, args = new Array(_len5), _key5 = 0; _key5 < _len5; _key5++) {\n              args[_key5] = arguments[_key5];\n            }\n            dispatch({\n              type: 'user-left',\n              value: args\n            });\n          });\n          if (rtcProps.tokenUrl) {\n            var tokenUrl = rtcProps.tokenUrl,\n              channel = rtcProps.channel,\n              _uid = rtcProps.uid;\n            client.on('token-privilege-will-expire', function () {\n              try {\n                console.log('token will expire');\n                return Promise.resolve(fetch(tokenUrl + '/rtc/' + channel + '/publisher/uid/' + (_uid || 0) + '/')).then(function (res) {\n                  return Promise.resolve(res.json()).then(function (data) {\n                    var token = data.rtcToken;\n                    client.renewToken(token);\n                  });\n                });\n              } catch (e) {\n                return Promise.reject(e);\n              }\n            });\n            client.on('token-privilege-did-expire', function () {\n              try {\n                return Promise.resolve(fetch(tokenUrl + '/rtc/' + channel + '/publisher/uid/' + (_uid || 0) + '/')).then(function (res) {\n                  return Promise.resolve(res.json()).then(function (data) {\n                    var token = data.rtcToken;\n                    client.renewToken(token);\n                  });\n                });\n              } catch (e) {\n                return Promise.reject(e);\n              }\n            });\n          }\n          if (callbacks) {\n            var events = Object.keys(callbacks);\n            events.map(function (e) {\n              try {\n                client.on(e, function () {\n                  ;\n                  for (var _len6 = arguments.length, args = new Array(_len6), _key6 = 0; _key6 < _len6; _key6++) {\n                    args[_key6] = arguments[_key6];\n                  }\n                  callbacks[e].apply(null, args);\n                });\n              } catch (e) {\n                console.log(e);\n              }\n            });\n          }\n          ;\n          joinRes(true);\n          setReady(true);\n        } catch (e) {\n          console.log('!!!', e);\n        }\n        return Promise.resolve();\n      } catch (e) {\n        return Promise.reject(e);\n      }\n    };\n    if (joinRes) {\n      init();\n      return function () {\n        try {\n          client.removeAllListeners();\n        } catch (e) {\n          console.log(e);\n        }\n      };\n    } else return function () {};\n  }, [rtcProps.appId]);\n  useEffect(function () {\n    var join = function join() {\n      try {\n        return Promise.resolve(canJoin.current).then(function () {\n          var tokenUrl = rtcProps.tokenUrl,\n            channel = rtcProps.channel,\n            userUid = rtcProps.uid,\n            appId = rtcProps.appId,\n            token = rtcProps.token;\n          var _temp3 = function () {\n            if (client && !ignore) {\n              if (rtcProps.role === 'audience') {\n                client.setClientRole(rtcProps.role);\n              } else {\n                client.setClientRole('host');\n              }\n              var _temp4 = function () {\n                if (tokenUrl) {\n                  var _temp5 = _catch(function () {\n                    return Promise.resolve(fetch(tokenUrl + '/rtc/' + channel + '/publisher/uid/' + (userUid || 0) + '/')).then(function (res) {\n                      return Promise.resolve(res.json()).then(function (data) {\n                        var token = data.rtcToken;\n                        return Promise.resolve(client.join(appId, channel, token, userUid || 0)).then(function (_client$join) {\n                          uid.current = _client$join;\n                        });\n                      });\n                    });\n                  }, function (e) {\n                    console.log(e);\n                  });\n                  if (_temp5 && _temp5.then) return _temp5.then(function () {});\n                } else {\n                  return Promise.resolve(client.join(appId, channel, token || null, userUid || 0)).then(function (_client$join2) {\n                    uid.current = _client$join2;\n                  });\n                }\n              }();\n              if (_temp4 && _temp4.then) return _temp4.then(function () {});\n            } else {\n              console.error('trying to join before RTC Engine was initialized');\n            }\n          }();\n          if (_temp3 && _temp3.then) return _temp3.then(function () {});\n        });\n      } catch (e) {\n        return Promise.reject(e);\n      }\n    };\n    var ignore = false;\n    if (callActive) {\n      join();\n      console.log('Attempted join: ', rtcProps.channel);\n    } else {\n      console.log('In precall - waiting to join');\n    }\n    return function () {\n      ignore = true;\n      if (callActive) {\n        console.log('Leaving channel');\n        try {\n          stopScreenshare();\n          isScreensharingRef.current = false;\n        } catch (e) {\n          console.log(e);\n        }\n        canJoin.current = client.leave()[\"catch\"](function (err) {\n          return console.log(err);\n        });\n      }\n    };\n  }, [rtcProps.channel, rtcProps.uid, callActive, rtcProps.tokenUrl]);\n  useEffect(function () {\n    var publish = function publish() {\n      try {\n        var _temp15 = function _temp15() {\n          function _temp10() {\n            var _temp8 = function () {\n              if (localVideoTrack !== null && localVideoTrack !== void 0 && localVideoTrack.enabled && channelJoined) {\n                var _temp13 = function () {\n                  if (!localVideoTrackHasPublished) {\n                    return Promise.resolve(client.publish([localVideoTrack]).then(function () {\n                      localVideoTrackHasPublished = true;\n                    })).then(function () {});\n                  }\n                }();\n                if (_temp13 && _temp13.then) return _temp13.then(function () {});\n              }\n            }();\n            if (_temp8 && _temp8.then) return _temp8.then(function () {});\n          }\n          var _temp9 = function () {\n            if (localAudioTrack !== null && localAudioTrack !== void 0 && localAudioTrack.enabled && channelJoined) {\n              var _temp14 = function () {\n                if (!localAudioTrackHasPublished) {\n                  return Promise.resolve(client.publish([localAudioTrack]).then(function () {\n                    localAudioTrackHasPublished = true;\n                  })).then(function () {});\n                }\n              }();\n              if (_temp14 && _temp14.then) return _temp14.then(function () {});\n            }\n          }();\n          return _temp9 && _temp9.then ? _temp9.then(_temp10) : _temp10(_temp9);\n        };\n        var _temp16 = function () {\n          if (rtcProps.enableDualStream) {\n            return Promise.resolve(client.enableDualStream()).then(function () {});\n          }\n        }();\n        return Promise.resolve(_temp16 && _temp16.then ? _temp16.then(_temp15) : _temp15(_temp16));\n      } catch (e) {\n        return Promise.reject(e);\n      }\n    };\n    console.log('Publish', localVideoTrack, localAudioTrack, callActive);\n    if (callActive) {\n      publish();\n    }\n  }, [callActive, localVideoTrack === null || localVideoTrack === void 0 ? void 0 : localVideoTrack.enabled, localAudioTrack === null || localAudioTrack === void 0 ? void 0 : localAudioTrack.enabled, channelJoined]);\n  useEffect(function () {\n    if (localVideoTrack && localAudioTrack !== null) {\n      mediaStore.current[0] = {\n        audioTrack: localAudioTrack,\n        videoTrack: localVideoTrack\n      };\n      dispatch({\n        type: 'update-user-video',\n        value: [localAudioTrack, localVideoTrack]\n      });\n    }\n  }, [rtcProps.channel, channelJoined]);\n  useEffect(function () {\n    if (channelJoined && rtcProps.token) {\n      client.renewToken(rtcProps.token).then(function (e) {\n        return console.log('renewed token', e);\n      });\n    }\n  }, [rtcProps.token, channelJoined]);\n  useEffect(function () {\n    if (rtcProps.role) {\n      client.setClientRole(rtcProps.role).then(function (e) {\n        return console.log('changed role', e);\n      });\n    }\n  }, [rtcProps.role, channelJoined]);\n  useEffect(function () {\n    var enableActiveSpeaker = function enableActiveSpeaker() {\n      try {\n        var _temp18 = function () {\n          if (rtcProps.activeSpeaker && rtcProps.layout !== layout.grid) {\n            client.on('volume-indicator', function (volumes) {\n              var highestvolumeObj = volumes.reduce(function (highestVolume, volume) {\n                if (highestVolume === null) {\n                  return volume;\n                } else {\n                  if (volume.level > highestVolume.level) {\n                    return volume;\n                  }\n                  return highestVolume;\n                }\n              }, null);\n              var activeSpeaker = highestvolumeObj ? highestvolumeObj.uid : undefined;\n              var mapActiveSpeakerToZero = activeSpeaker === uid.current ? 0 : activeSpeaker;\n              if (activeSpeaker !== undefined) {\n                dispatch({\n                  type: 'ActiveSpeaker',\n                  value: [mapActiveSpeakerToZero]\n                });\n              }\n            });\n            return Promise.resolve(client.enableAudioVolumeIndicator()).then(function () {});\n          }\n        }();\n        return Promise.resolve(_temp18 && _temp18.then ? _temp18.then(function () {}) : void 0);\n      } catch (e) {\n        return Promise.reject(e);\n      }\n    };\n    if (callActive) {\n      enableActiveSpeaker();\n    }\n    return function () {\n      client.removeAllListeners('volume-indicator');\n    };\n  }, [rtcProps.activeSpeaker, rtcProps.layout]);\n  var toggleScreensharing = function toggleScreensharing() {\n    try {\n      var start = function start() {\n        try {\n          dispatch({\n            type: 'Screensharing',\n            value: [true]\n          });\n          return Promise.resolve(AgoraRTC.createScreenVideoTrack({}, 'disable')).then(function (_AgoraRTC$createScree) {\n            screenTrack.current = _AgoraRTC$createScree;\n            var uid = rtcProps.screenshareUid || 1;\n            mediaStore.current[uid] = {\n              videoTrack: screenTrack.current\n            };\n            screenTrack.current.on('track-ended', function () {\n              isScreensharingRef.current = false;\n              dispatch({\n                type: 'Screensharing',\n                value: [false]\n              });\n            });\n            isScreensharingRef.current = true;\n            return Promise.resolve(startScreenshare(rtcProps.appId, rtcProps.channel, screenTrack.current, rtcProps.screenshareToken, rtcProps.screenshareUid, rtcProps.tokenUrl, rtcProps.enableDualStream)).then(function () {});\n          });\n        } catch (e) {\n          return Promise.reject(e);\n        }\n      };\n      var stop = function stop() {\n        stopScreenshare();\n        isScreensharingRef.current = false;\n      };\n      if (isScreensharingRef.current) {\n        stop();\n      } else {\n        start();\n      }\n      return Promise.resolve();\n    } catch (e) {\n      return Promise.reject(e);\n    }\n  };\n  return React.createElement(RtcProvider, {\n    value: {\n      client: client,\n      mediaStore: mediaStore.current,\n      localVideoTrack: localVideoTrack,\n      localAudioTrack: localAudioTrack,\n      dispatch: dispatch,\n      localUid: uid,\n      channelJoined: channelJoined,\n      toggleScreensharing: toggleScreensharing,\n      isScreensharing: isScreensharingRef.current\n    }\n  }, React.createElement(MaxUidProvider, {\n    value: uidState.max\n  }, React.createElement(MinUidProvider, {\n    value: uidState.min\n  }, ready ? props.children : null)));\n};\nvar icons = {\n  videocam: React.createElement(React.Fragment, null, React.createElement(\"polygon\", {\n    points: '23 7 16 12 23 17 23 7'\n  }), React.createElement(\"rect\", {\n    x: '1',\n    y: '5',\n    width: '15',\n    height: '14',\n    rx: '2',\n    ry: '2'\n  })),\n  videocamOff: React.createElement(React.Fragment, null, React.createElement(\"path\", {\n    d: 'M16 16v1a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2h2m5.66 0H14a2 2 0 0 1 2 2v3.34l1 1L23 7v10'\n  }), React.createElement(\"line\", {\n    x1: '1',\n    y1: '1',\n    x2: '23',\n    y2: '23'\n  })),\n  remoteSwap: React.createElement(React.Fragment, null, React.createElement(\"polyline\", {\n    points: '15 3 21 3 21 9'\n  }), React.createElement(\"polyline\", {\n    points: '9 21 3 21 3 15'\n  }), React.createElement(\"line\", {\n    x1: '21',\n    y1: '3',\n    x2: '14',\n    y2: '10'\n  }), React.createElement(\"line\", {\n    x1: '3',\n    y1: '21',\n    x2: '10',\n    y2: '14'\n  })),\n  callEnd: React.createElement(React.Fragment, null, React.createElement(\"path\", {\n    d: 'M10.68 13.31a16 16 0 0 0 3.41 2.6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7 2 2 0 0 1 1.72 2v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.42 19.42 0 0 1-3.33-2.67m-2.67-3.34a19.79 19.79 0 0 1-3.07-8.63A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91'\n  }), React.createElement(\"line\", {\n    x1: '23',\n    y1: '1',\n    x2: '1',\n    y2: '23'\n  })),\n  mic: React.createElement(React.Fragment, null, React.createElement(\"path\", {\n    d: 'M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z'\n  }), React.createElement(\"path\", {\n    d: 'M19 10v2a7 7 0 0 1-14 0v-2'\n  }), React.createElement(\"line\", {\n    x1: '12',\n    y1: '19',\n    x2: '12',\n    y2: '23'\n  }), React.createElement(\"line\", {\n    x1: '8',\n    y1: '23',\n    x2: '16',\n    y2: '23'\n  })),\n  micOff: React.createElement(React.Fragment, null, React.createElement(\"line\", {\n    x1: '1',\n    y1: '1',\n    x2: '23',\n    y2: '23'\n  }), React.createElement(\"path\", {\n    d: 'M9 9v3a3 3 0 0 0 5.12 2.12M15 9.34V4a3 3 0 0 0-5.94-.6'\n  }), React.createElement(\"path\", {\n    d: 'M17 16.95A7 7 0 0 1 5 12v-2m14 0v2a7 7 0 0 1-.11 1.23'\n  }), React.createElement(\"line\", {\n    x1: '12',\n    y1: '19',\n    x2: '12',\n    y2: '23'\n  }), React.createElement(\"line\", {\n    x1: '8',\n    y1: '23',\n    x2: '16',\n    y2: '23'\n  })),\n  screen: React.createElement(React.Fragment, null, React.createElement(\"rect\", {\n    x: '2',\n    y: '3',\n    width: '20',\n    height: '14',\n    rx: '2',\n    ry: '2'\n  }), React.createElement(\"line\", {\n    x1: '8',\n    y1: '21',\n    x2: '16',\n    y2: '21'\n  }), React.createElement(\"line\", {\n    x1: '12',\n    y1: '17',\n    x2: '12',\n    y2: '21'\n  })),\n  stop: React.createElement(React.Fragment, null, React.createElement(\"line\", {\n    x1: '18',\n    y1: '6',\n    x2: '6',\n    y2: '18'\n  }), React.createElement(\"line\", {\n    x1: '6',\n    y1: '6',\n    x2: '18',\n    y2: '18'\n  }))\n};\nvar BtnTemplate = function BtnTemplate(props) {\n  var onClick = props.onClick,\n    name = props.name,\n    disabled = props.disabled,\n    style = props.style;\n  var _useContext = useContext(PropsContext),\n    styleProps = _useContext.styleProps;\n  var _ref = styleProps || {},\n    theme = _ref.theme,\n    BtnTemplateStyles = _ref.BtnTemplateStyles,\n    iconSize = _ref.iconSize,\n    customIcon = _ref.customIcon;\n  return React.createElement(\"div\", {\n    style: _extends({}, {\n      width: 35,\n      height: 35,\n      borderRadius: '100%',\n      borderWidth: 2,\n      borderStyle: 'solid',\n      borderColor: '#fff',\n      backgroundColor: 'rgba(0,80,180,0.2)',\n      alignItems: 'center',\n      justifyContent: 'center',\n      display: 'flex',\n      cursor: disabled ? 'auto' : 'pointer',\n      margin: 4\n    }, BtnTemplateStyles, style),\n    onClick: onClick\n  }, customIcon ? React.createElement(\"img\", {\n    src: customIcon[name],\n    alt: name\n  }) : React.createElement(\"svg\", {\n    style: {\n      width: iconSize || 24,\n      height: iconSize || 24\n    },\n    xmlns: 'http://www.w3.org/2000/svg',\n    width: '24',\n    height: '24',\n    viewBox: '0 0 24 24',\n    fill: 'none',\n    opacity: disabled ? '0.5' : '1',\n    stroke: theme || '#fff',\n    strokeWidth: '2',\n    strokeLinecap: 'round',\n    strokeLinejoin: 'round'\n  }, icons[name]));\n};\nfunction EndCall() {\n  var _useContext = useContext(PropsContext),\n    styleProps = _useContext.styleProps,\n    callbacks = _useContext.callbacks;\n  var _ref = styleProps || {},\n    localBtnStyles = _ref.localBtnStyles;\n  var _ref2 = localBtnStyles || {},\n    endCall = _ref2.endCall;\n  return React.createElement(BtnTemplate, {\n    style: endCall || {\n      backgroundColor: '#ef5588',\n      borderColor: '#f00'\n    },\n    name: 'callEnd',\n    onClick: function onClick() {\n      return (callbacks === null || callbacks === void 0 ? void 0 : callbacks.EndCall) && callbacks.EndCall();\n    }\n  });\n}\nvar LocalContext = createContext({});\nvar LocalUserContext = function LocalUserContext(props) {\n  var max = useContext(MaxUidContext);\n  var min = useContext(MinUidContext);\n  var localUser;\n  if (max[0].uid === 0) {\n    localUser = max[0];\n  } else {\n    localUser = min.find(function (u) {\n      return u.uid === 0;\n    });\n  }\n  return React.createElement(LocalContext.Provider, {\n    value: localUser\n  }, props.children);\n};\nvar muteAudio = function muteAudio(user, dispatch, localAudioTrack, callbacks) {\n  try {\n    var _temp4 = function () {\n      if (user.uid === 0) {\n        var localState = user.hasAudio;\n        var _temp5 = function () {\n          if (localState === ToggleState.enabled || localState === ToggleState.disabled) {\n            var newState = localState === ToggleState.enabled ? ToggleState.disabling : ToggleState.enabling;\n            dispatch({\n              type: 'local-user-mute-audio',\n              value: [newState]\n            });\n            callbacks && callbacks['local-user-mute-audio'] && callbacks['local-user-mute-audio'](newState);\n            var _temp6 = _catch(function () {\n              return Promise.resolve(localAudioTrack === null || localAudioTrack === void 0 ? void 0 : localAudioTrack.setEnabled(localState !== ToggleState.enabled)).then(function () {\n                newState = localState === ToggleState.enabled ? ToggleState.disabled : ToggleState.enabled;\n                callbacks && callbacks['local-user-mute-audio'] && callbacks['local-user-mute-audio'](newState);\n                dispatch({\n                  type: 'local-user-mute-audio',\n                  value: [localState === ToggleState.enabled ? ToggleState.disabled : ToggleState.enabled]\n                });\n              });\n            }, function () {\n              dispatch({\n                type: 'local-user-mute-audio',\n                value: [localState]\n              });\n            });\n            if (_temp6 && _temp6.then) return _temp6.then(function () {});\n          }\n        }();\n        if (_temp5 && _temp5.then) return _temp5.then(function () {});\n      }\n    }();\n    return Promise.resolve(_temp4 && _temp4.then ? _temp4.then(function () {}) : void 0);\n  } catch (e) {\n    return Promise.reject(e);\n  }\n};\nfunction LocalAudioMute() {\n  var _useContext = useContext(PropsContext),\n    styleProps = _useContext.styleProps,\n    callbacks = _useContext.callbacks;\n  var _ref = styleProps || {},\n    localBtnStyles = _ref.localBtnStyles;\n  var _ref2 = localBtnStyles || {},\n    muteLocalAudio = _ref2.muteLocalAudio;\n  var _useContext2 = useContext(RtcContext),\n    dispatch = _useContext2.dispatch,\n    localAudioTrack = _useContext2.localAudioTrack;\n  var local = useContext(LocalContext);\n  return React.createElement(\"div\", null, React.createElement(BtnTemplate, {\n    style: muteLocalAudio,\n    name: local.hasAudio === ToggleState.enabled ? 'mic' : 'micOff',\n    onClick: function onClick() {\n      return localAudioTrack && muteAudio(local, dispatch, localAudioTrack, callbacks);\n    }\n  }));\n}\nfunction Screenshare() {\n  var _useContext = useContext(PropsContext),\n    styleProps = _useContext.styleProps;\n  var _ref = styleProps || {},\n    localBtnStyles = _ref.localBtnStyles;\n  var _ref2 = localBtnStyles || {},\n    screenshare = _ref2.screenshare;\n  var _useContext2 = useContext(RtcContext),\n    toggleScreensharing = _useContext2.toggleScreensharing,\n    isScreensharing = _useContext2.isScreensharing;\n  return React.createElement(\"div\", null, React.createElement(BtnTemplate, {\n    style: screenshare,\n    name: isScreensharing ? 'stop' : 'screen',\n    onClick: function onClick() {\n      return toggleScreensharing();\n    }\n  }));\n}\nvar muteVideo = function muteVideo(user, dispatch, localVideoTrack, callbacks) {\n  try {\n    var _temp4 = function () {\n      if (user.uid === 0) {\n        var localState = user.hasVideo;\n        var _temp5 = function () {\n          if (localState === ToggleState.enabled || localState === ToggleState.disabled) {\n            var newState = localState === ToggleState.enabled ? ToggleState.disabling : ToggleState.enabling;\n            dispatch({\n              type: 'local-user-mute-video',\n              value: [newState]\n            });\n            callbacks && callbacks['local-user-mute-video'] && callbacks['local-user-mute-video'](newState);\n            var _temp6 = _catch(function () {\n              return Promise.resolve(localVideoTrack === null || localVideoTrack === void 0 ? void 0 : localVideoTrack.setEnabled(localState !== ToggleState.enabled)).then(function () {\n                newState = localState === ToggleState.enabled ? ToggleState.disabled : ToggleState.enabled;\n                callbacks && callbacks['local-user-mute-video'] && callbacks['local-user-mute-video'](newState);\n                dispatch({\n                  type: 'local-user-mute-video',\n                  value: [newState]\n                });\n              });\n            }, function () {\n              dispatch({\n                type: 'local-user-mute-video',\n                value: [localState]\n              });\n            });\n            if (_temp6 && _temp6.then) return _temp6.then(function () {});\n          }\n        }();\n        if (_temp5 && _temp5.then) return _temp5.then(function () {});\n      }\n    }();\n    return Promise.resolve(_temp4 && _temp4.then ? _temp4.then(function () {}) : void 0);\n  } catch (e) {\n    return Promise.reject(e);\n  }\n};\nfunction LocalVideoMute() {\n  var _useContext = useContext(PropsContext),\n    styleProps = _useContext.styleProps,\n    callbacks = _useContext.callbacks;\n  var _ref = styleProps || {},\n    localBtnStyles = _ref.localBtnStyles;\n  var _ref2 = localBtnStyles || {},\n    muteLocalVideo = _ref2.muteLocalVideo;\n  var _useContext2 = useContext(RtcContext),\n    dispatch = _useContext2.dispatch,\n    localVideoTrack = _useContext2.localVideoTrack;\n  var local = useContext(LocalContext);\n  return React.createElement(\"div\", null, React.createElement(BtnTemplate, {\n    style: muteLocalVideo,\n    name: local.hasVideo === ToggleState.enabled ? 'videocam' : 'videocamOff',\n    onClick: function onClick() {\n      return localVideoTrack && muteVideo(local, dispatch, localVideoTrack, callbacks);\n    }\n  }));\n}\nfunction LocalControls() {\n  var _useContext = useContext(PropsContext),\n    styleProps = _useContext.styleProps,\n    rtcProps = _useContext.rtcProps;\n  var _ref = styleProps || {},\n    localBtnContainer = _ref.localBtnContainer;\n  return React.createElement(\"div\", {\n    style: _extends({}, {\n      backgroundColor: '#007bff',\n      width: '100%',\n      height: 70,\n      zIndex: 10,\n      display: 'flex',\n      flexDirection: 'row',\n      justifyContent: 'space-evenly',\n      alignItems: 'center'\n    }, localBtnContainer)\n  }, rtcProps.role !== 'audience' && React.createElement(LocalVideoMute, null), rtcProps.role !== 'audience' && React.createElement(LocalAudioMute, null), rtcProps.role !== 'audience' && rtcProps.enableScreensharing && React.createElement(Screenshare, null), React.createElement(EndCall, null));\n}\nvar rtmStatusEnum;\n(function (rtmStatusEnum) {\n  rtmStatusEnum[rtmStatusEnum[\"initFailed\"] = 0] = \"initFailed\";\n  rtmStatusEnum[rtmStatusEnum[\"offline\"] = 1] = \"offline\";\n  rtmStatusEnum[rtmStatusEnum[\"initialising\"] = 2] = \"initialising\";\n  rtmStatusEnum[rtmStatusEnum[\"loggingIn\"] = 3] = \"loggingIn\";\n  rtmStatusEnum[rtmStatusEnum[\"loggedIn\"] = 4] = \"loggedIn\";\n  rtmStatusEnum[rtmStatusEnum[\"connected\"] = 5] = \"connected\";\n  rtmStatusEnum[rtmStatusEnum[\"loginFailed\"] = 6] = \"loginFailed\";\n})(rtmStatusEnum || (rtmStatusEnum = {}));\nvar clientRoleRaw;\n(function (clientRoleRaw) {\n  clientRoleRaw[clientRoleRaw[\"broadcaster\"] = 0] = \"broadcaster\";\n  clientRoleRaw[clientRoleRaw[\"audience\"] = 1] = \"audience\";\n})(clientRoleRaw || (clientRoleRaw = {}));\nvar mutingDevice;\n(function (mutingDevice) {\n  mutingDevice[mutingDevice[\"camera\"] = 0] = \"camera\";\n  mutingDevice[mutingDevice[\"microphone\"] = 1] = \"microphone\";\n})(mutingDevice || (mutingDevice = {}));\nvar popUpStateEnum;\n(function (popUpStateEnum) {\n  popUpStateEnum[popUpStateEnum[\"closed\"] = 0] = \"closed\";\n  popUpStateEnum[popUpStateEnum[\"muteMic\"] = 1] = \"muteMic\";\n  popUpStateEnum[popUpStateEnum[\"muteCamera\"] = 2] = \"muteCamera\";\n  popUpStateEnum[popUpStateEnum[\"unmuteMic\"] = 3] = \"unmuteMic\";\n  popUpStateEnum[popUpStateEnum[\"unmuteCamera\"] = 4] = \"unmuteCamera\";\n})(popUpStateEnum || (popUpStateEnum = {}));\nvar RtmContext = createContext(null);\nvar RtmProvider = RtmContext.Provider;\nvar RtmConsumer = RtmContext.Consumer;\nfunction RemoteVideoMute(props) {\n  var _useContext = useContext(PropsContext),\n    styleProps = _useContext.styleProps;\n  var _useContext2 = useContext(RtmContext),\n    sendMuteRequest = _useContext2.sendMuteRequest,\n    uidMap = _useContext2.uidMap;\n  var _ref = styleProps || {},\n    remoteBtnStyles = _ref.remoteBtnStyles;\n  var _ref2 = remoteBtnStyles || {},\n    muteRemoteVideo = _ref2.muteRemoteVideo;\n  var UIKitUser = props.UIKitUser;\n  var isMuted = UIKitUser.hasVideo === remoteTrackState.no;\n  return UIKitUser.uid !== 0 && uidMap[UIKitUser.uid] ? React.createElement(\"div\", null, React.createElement(BtnTemplate, {\n    name: UIKitUser.hasVideo === remoteTrackState.subbed ? 'videocam' : 'videocamOff',\n    style: muteRemoteVideo,\n    onClick: function onClick() {\n      return sendMuteRequest(mutingDevice.camera, UIKitUser.uid, !isMuted);\n    }\n  })) : null;\n}\nfunction RemoteAudioMute(props) {\n  var _useContext = useContext(PropsContext),\n    styleProps = _useContext.styleProps;\n  var _ref = styleProps || {},\n    remoteBtnStyles = _ref.remoteBtnStyles;\n  var _useContext2 = useContext(RtmContext),\n    sendMuteRequest = _useContext2.sendMuteRequest,\n    uidMap = _useContext2.uidMap;\n  var _ref2 = remoteBtnStyles || {},\n    muteRemoteAudio = _ref2.muteRemoteAudio;\n  var UIKitUser = props.UIKitUser;\n  var isMuted = UIKitUser.hasAudio === remoteTrackState.no;\n  return UIKitUser.uid !== 0 && uidMap[UIKitUser.uid] ? React.createElement(\"div\", null, React.createElement(BtnTemplate, {\n    style: muteRemoteAudio,\n    name: UIKitUser.hasAudio === remoteTrackState.subbed ? 'mic' : 'micOff',\n    onClick: function onClick() {\n      return sendMuteRequest(mutingDevice.microphone, UIKitUser.uid, !isMuted);\n    }\n  })) : null;\n}\nfunction SwapUser(props) {\n  var _useContext = useContext(RtcContext),\n    dispatch = _useContext.dispatch;\n  var UIKitUser = props.UIKitUser;\n  return React.createElement(\"div\", null, React.createElement(BtnTemplate, {\n    name: 'remoteSwap',\n    onClick: function onClick() {\n      return dispatch({\n        type: 'user-swap',\n        value: [UIKitUser]\n      });\n    }\n  }));\n}\nvar VideoPlaceholder = function VideoPlaceholder(props) {\n  var _useContext = useContext(PropsContext),\n    styleProps = _useContext.styleProps,\n    rtcProps = _useContext.rtcProps;\n  var _ref = styleProps || {},\n    maxViewStyles = _ref.maxViewStyles,\n    maxViewOverlayContainer = _ref.maxViewOverlayContainer;\n  var user = props.user;\n  var CustomVideoPlaceholder = rtcProps.CustomVideoPlaceholder;\n  return !CustomVideoPlaceholder ? React.createElement(\"div\", {\n    key: user.uid,\n    style: _extends({}, style.max, maxViewStyles)\n  }, React.createElement(\"div\", {\n    style: style.imgContainer\n  }, React.createElement(\"img\", {\n    style: style.img,\n    src: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9ImN1cnJlbnRDb2xvciIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiIGNsYXNzPSJmZWF0aGVyIGZlYXRoZXItdXNlciI+PHBhdGggZD0iTTIwIDIxdi0yYTQgNCAwIDAgMC00LTRIOGE0IDQgMCAwIDAtNCA0djIiPjwvcGF0aD48Y2lyY2xlIGN4PSIxMiIgY3k9IjciIHI9IjQiPjwvY2lyY2xlPjwvc3ZnPg=='\n  })), props.isShown && React.createElement(\"div\", {\n    style: _extends({}, style.btnContainer, maxViewOverlayContainer)\n  }, props.showButtons && React.createElement(React.Fragment, null, !rtcProps.disableRtm && React.createElement(RemoteVideoMute, {\n    UIKitUser: user\n  }), !rtcProps.disableRtm && React.createElement(RemoteAudioMute, {\n    UIKitUser: user\n  }), props.showSwap && React.createElement(SwapUser, {\n    UIKitUser: user\n  })))) : CustomVideoPlaceholder && CustomVideoPlaceholder(_extends({}, props), null);\n};\nvar style = {\n  max: {\n    flex: 1,\n    display: 'flex',\n    backgroundColor: '#007bff33',\n    flexDirection: 'row',\n    position: 'relative'\n  },\n  imgContainer: {\n    flex: 10,\n    display: 'flex',\n    justifyContent: 'center'\n  },\n  img: {\n    width: 100,\n    height: 100,\n    position: 'absolute',\n    alignSelf: 'center',\n    justifySelf: 'center',\n    margin: 'auto',\n    display: 'flex'\n  },\n  btnContainer: {\n    position: 'absolute',\n    margin: 5,\n    flexDirection: 'column',\n    display: 'flex'\n  }\n};\nvar Username = function Username(props) {\n  var _useContext = useContext(RtmContext),\n    usernames = _useContext.usernames;\n  var _useContext2 = useContext(PropsContext),\n    rtmProps = _useContext2.rtmProps,\n    styleProps = _useContext2.styleProps;\n  var user = props.user;\n  return rtmProps !== null && rtmProps !== void 0 && rtmProps.displayUsername ? React.createElement(\"p\", {\n    style: _extends({}, styles.username, styleProps === null || styleProps === void 0 ? void 0 : styleProps.usernameText)\n  }, user.uid === 1 ? 'Screenshare' : usernames[user.uid]) : React.createElement(React.Fragment, null);\n};\nvar styles = {\n  username: {\n    position: 'absolute',\n    background: '#007bffaa',\n    padding: '2px 8px',\n    color: '#fff',\n    margin: 0,\n    bottom: 0,\n    right: 0,\n    zIndex: 90\n  }\n};\nvar MaxVideoView = function MaxVideoView(props) {\n  var _useContext = useContext(RtcContext),\n    mediaStore = _useContext.mediaStore;\n  var _useContext2 = useContext(PropsContext),\n    styleProps = _useContext2.styleProps,\n    rtcProps = _useContext2.rtcProps;\n  var _ref = styleProps || {},\n    maxViewStyles = _ref.maxViewStyles,\n    videoMode = _ref.videoMode,\n    maxViewOverlayContainer = _ref.maxViewOverlayContainer;\n  var renderModeProp = videoMode === null || videoMode === void 0 ? void 0 : videoMode.max;\n  var _useState = useState(false),\n    isShown = _useState[0],\n    setIsShown = _useState[1];\n  var user = props.user;\n  return React.createElement(\"div\", {\n    style: _extends({}, styles$1.container, props.style, maxViewStyles),\n    onMouseEnter: function onMouseEnter() {\n      return setIsShown(true);\n    },\n    onMouseLeave: function onMouseLeave() {\n      return setIsShown(false);\n    }\n  }, user.hasVideo === 1 ? React.createElement(\"div\", {\n    style: styles$1.videoContainer\n  }, !rtcProps.disableRtm && React.createElement(Username, {\n    user: user\n  }), React.createElement(AgoraVideoPlayer, {\n    style: styles$1.videoplayer,\n    config: {\n      fit: renderModeProp || 'cover'\n    },\n    videoTrack: mediaStore[user.uid].videoTrack\n  }), isShown && React.createElement(\"div\", {\n    style: _extends({}, styles$1.overlay, maxViewOverlayContainer)\n  }, !rtcProps.disableRtm && React.createElement(RemoteVideoMute, {\n    UIKitUser: user\n  }), !rtcProps.disableRtm && React.createElement(RemoteAudioMute, {\n    UIKitUser: user\n  }))) : React.createElement(\"div\", {\n    style: styles$1.videoContainer\n  }, !rtcProps.disableRtm && React.createElement(Username, {\n    user: user\n  }), React.createElement(VideoPlaceholder, {\n    user: user,\n    isShown: isShown,\n    showButtons: true\n  })));\n};\nvar styles$1 = {\n  container: {\n    display: 'flex',\n    flex: 1\n  },\n  videoContainer: {\n    display: 'flex',\n    flex: 1,\n    position: 'relative'\n  },\n  videoplayer: {\n    width: '100%',\n    display: 'flex',\n    flex: 1\n  },\n  overlay: {\n    position: 'absolute',\n    margin: 5,\n    flexDirection: 'column',\n    display: 'flex'\n  },\n  username: {\n    position: 'absolute',\n    background: '#007bffaa',\n    padding: '2px 8px',\n    color: '#fff',\n    margin: 0,\n    bottom: 0,\n    right: 0,\n    zIndex: 90\n  }\n};\nvar MinVideoView = function MinVideoView(props) {\n  var _useContext = useContext(RtcContext),\n    mediaStore = _useContext.mediaStore;\n  var _useContext2 = useContext(PropsContext),\n    styleProps = _useContext2.styleProps,\n    rtcProps = _useContext2.rtcProps;\n  var _ref = styleProps || {},\n    minViewStyles = _ref.minViewStyles,\n    videoMode = _ref.videoMode,\n    minViewOverlayContainer = _ref.minViewOverlayContainer;\n  var renderModeProp = videoMode === null || videoMode === void 0 ? void 0 : videoMode.min;\n  var _useState = useState(false),\n    isShown = _useState[0],\n    setIsShown = _useState[1];\n  var user = props.user;\n  return React.createElement(\"div\", {\n    style: _extends({}, {\n      display: 'flex',\n      flex: 1\n    }, minViewStyles),\n    onMouseEnter: function onMouseEnter() {\n      return setIsShown(true);\n    },\n    onMouseLeave: function onMouseLeave() {\n      return setIsShown(false);\n    }\n  }, user.hasVideo === 1 ? React.createElement(\"div\", {\n    style: _extends({}, {\n      display: 'flex',\n      flex: 1,\n      position: 'relative'\n    })\n  }, React.createElement(AgoraVideoPlayer, {\n    style: {\n      flex: 10,\n      display: 'flex'\n    },\n    config: {\n      fit: renderModeProp !== undefined ? renderModeProp : 'cover'\n    },\n    videoTrack: mediaStore[user.uid].videoTrack\n  }), isShown && React.createElement(\"div\", {\n    style: _extends({}, {\n      margin: 4,\n      position: 'absolute',\n      flex: 1,\n      display: 'flex',\n      flexDirection: 'column'\n    }, minViewOverlayContainer)\n  }, !rtcProps.disableRtm && React.createElement(RemoteVideoMute, {\n    UIKitUser: user\n  }), !rtcProps.disableRtm && React.createElement(RemoteAudioMute, {\n    UIKitUser: user\n  }), React.createElement(SwapUser, {\n    UIKitUser: user\n  }))) : React.createElement(VideoPlaceholder, {\n    user: user,\n    isShown: isShown,\n    showButtons: true,\n    showSwap: true\n  }));\n};\nvar styles$2 = {\n  \"test\": \"_3ybTi\",\n  \"scrollbar\": \"_3Sxu7\"\n};\nvar PinnedVideo = function PinnedVideo() {\n  var _useContext = useContext(PropsContext),\n    styleProps = _useContext.styleProps,\n    rtcProps = _useContext.rtcProps;\n  var _ref = styleProps || {},\n    minViewContainer = _ref.minViewContainer,\n    pinnedVideoContainer = _ref.pinnedVideoContainer,\n    maxViewContainer = _ref.maxViewContainer,\n    scrollViewContainer = _ref.scrollViewContainer;\n  var parentRef = useRef(null);\n  var _useState = useState(0),\n    width = _useState[0],\n    setWidth = _useState[1];\n  var _useState2 = useState(0),\n    height = _useState2[0],\n    setHeight = _useState2[1];\n  var isLandscape = width > height;\n  useEffect(function () {\n    var handleResize = function handleResize() {\n      if (parentRef.current) {\n        setWidth(parentRef.current.offsetWidth);\n        setHeight(parentRef.current.offsetHeight);\n      }\n    };\n    window.addEventListener('resize', handleResize);\n    if (parentRef.current) {\n      setWidth(parentRef.current.offsetWidth);\n      setHeight(parentRef.current.offsetHeight);\n    }\n    return function () {\n      window.removeEventListener('resize', handleResize);\n    };\n  }, []);\n  return React.createElement(\"div\", {\n    ref: parentRef,\n    style: _extends({}, {\n      display: 'flex',\n      flex: 1,\n      flexDirection: isLandscape ? 'row' : 'column-reverse',\n      overflow: 'hidden'\n    }, pinnedVideoContainer)\n  }, React.createElement(\"div\", {\n    style: _extends({}, {\n      display: 'flex',\n      flex: isLandscape ? 5 : 4\n    }, maxViewContainer)\n  }, React.createElement(MaxUidConsumer, null, function (maxUsers) {\n    return rtcProps.role === 'audience' && maxUsers[0].uid === 0 ? null : React.createElement(MaxVideoView, {\n      user: maxUsers[0]\n    });\n  })), React.createElement(\"div\", {\n    className: styles$2.scrollbar,\n    style: _extends({}, {\n      overflowY: isLandscape ? 'scroll' : 'hidden',\n      overflowX: !isLandscape ? 'scroll' : 'hidden',\n      display: 'flex',\n      flex: 1,\n      flexDirection: isLandscape ? 'column' : 'row'\n    }, scrollViewContainer)\n  }, React.createElement(MinUidConsumer, null, function (minUsers) {\n    return minUsers.map(function (user) {\n      return rtcProps.role === 'audience' && user.uid === 0 ? null : React.createElement(\"div\", {\n        style: _extends({}, {\n          minHeight: isLandscape ? '35vh' : '99%',\n          minWidth: isLandscape ? '99%' : '40vw',\n          margin: 2,\n          display: 'flex'\n        }, minViewContainer),\n        key: user.uid\n      }, React.createElement(MinVideoView, {\n        user: user\n      }));\n    });\n  })));\n};\nvar GridVideo = function GridVideo() {\n  var _useContext = useContext(PropsContext),\n    styleProps = _useContext.styleProps,\n    rtcProps = _useContext.rtcProps;\n  var _ref = styleProps || {},\n    gridVideoCells = _ref.gridVideoCells,\n    gridVideoContainer = _ref.gridVideoContainer;\n  var max = useContext(MaxUidContext);\n  var min = useContext(MinUidContext);\n  var users = rtcProps.role === 'audience' ? [].concat(max, min).filter(function (user) {\n    return user.uid !== 0;\n  }) : [].concat(max, min);\n  var parentRef = useRef(null);\n  var _useState = useState(window.innerWidth),\n    width = _useState[0],\n    setWidth = _useState[1];\n  var _useState2 = useState(window.innerHeight),\n    height = _useState2[0],\n    setHeight = _useState2[1];\n  var isLandscape = width > height;\n  var unit = 'minmax(0, 1fr) ';\n  useEffect(function () {\n    var handleResize = function handleResize() {\n      if (parentRef.current) {\n        setWidth(parentRef.current.offsetWidth);\n        setHeight(parentRef.current.offsetHeight);\n      }\n    };\n    window.addEventListener('resize', handleResize);\n    if (parentRef.current) {\n      setWidth(parentRef.current.offsetWidth);\n      setHeight(parentRef.current.offsetHeight);\n    }\n    return function () {\n      window.removeEventListener('resize', handleResize);\n    };\n  }, []);\n  return React.createElement(\"div\", {\n    ref: parentRef,\n    style: _extends({}, {\n      width: '100%',\n      height: '100%',\n      display: 'grid',\n      gridTemplateColumns: isLandscape ? users.length > 9 ? unit.repeat(4) : users.length > 4 ? unit.repeat(3) : users.length > 1 ? unit.repeat(2) : unit : users.length > 8 ? unit.repeat(3) : users.length > 2 ? unit.repeat(2) : unit\n    }, gridVideoContainer)\n  }, users.map(function (user) {\n    return React.createElement(MaxVideoView, {\n      user: user,\n      style: _extends({}, {\n        height: '100%',\n        width: '100%'\n      }, gridVideoCells),\n      key: user.uid\n    });\n  }));\n};\nvar useTracks = createMicrophoneAndCameraTracks({\n  encoderConfig: {}\n}, {\n  encoderConfig: {}\n});\nvar TracksConfigure = function TracksConfigure(props) {\n  var _useState = useState(false),\n    ready = _useState[0],\n    setReady = _useState[1];\n  var _useState2 = useState(null),\n    localVideoTrack = _useState2[0],\n    setLocalVideoTrack = _useState2[1];\n  var _useState3 = useState(null),\n    localAudioTrack = _useState3[0],\n    setLocalAudioTrack = _useState3[1];\n  var _useTracks = useTracks(),\n    trackReady = _useTracks.ready,\n    tracks = _useTracks.tracks,\n    error = _useTracks.error;\n  var mediaStore = useRef({});\n  useEffect(function () {\n    if (tracks !== null) {\n      setLocalAudioTrack(tracks[0]);\n      setLocalVideoTrack(tracks[1]);\n      mediaStore.current[0] = {\n        audioTrack: tracks[0],\n        videoTrack: tracks[1]\n      };\n      setReady(true);\n    } else if (error) {\n      console.error(error);\n      setReady(false);\n    }\n    return function () {\n      if (tracks) {\n        var _tracks$, _tracks$2;\n        (_tracks$ = tracks[0]) === null || _tracks$ === void 0 ? void 0 : _tracks$.close();\n        (_tracks$2 = tracks[1]) === null || _tracks$2 === void 0 ? void 0 : _tracks$2.close();\n      }\n    };\n  }, [trackReady, error]);\n  return React.createElement(TracksProvider, {\n    value: {\n      localVideoTrack: localVideoTrack,\n      localAudioTrack: localAudioTrack\n    }\n  }, ready ? props.children : null);\n};\nvar timeNow = function timeNow() {\n  return new Date().getTime();\n};\nvar useChannel = createLazyChannel();\nvar useClient$1 = createLazyClient();\nvar RtmConfigure = function RtmConfigure(props) {\n  var _useContext = useContext(PropsContext),\n    rtcProps = _useContext.rtcProps,\n    rtmProps = _useContext.rtmProps;\n  var _useState = useState(false),\n    isLoggedIn = _useState[0],\n    setLoggedIn = _useState[1];\n  var rtmClient = useClient$1(rtcProps.appId);\n  var channel = useChannel(rtmClient, rtcProps.channel);\n  var localUid = useRef('');\n  var timerValueRef = useRef(5);\n  var local = useContext(LocalContext);\n  var _useContext2 = useContext(PropsContext),\n    rtmCallbacks = _useContext2.rtmCallbacks;\n  var _useState2 = useState({}),\n    uidMap = _useState2[0],\n    setUidMap = _useState2[1];\n  var _useState3 = useState({}),\n    usernames = _useState3[0],\n    setUsernames = _useState3[1];\n  var _useState4 = useState({}),\n    userDataMap = _useState4[0],\n    setUserDataMap = _useState4[1];\n  var _useState5 = useState(popUpStateEnum.closed),\n    popUpState = _useState5[0],\n    setPopUpState = _useState5[1];\n  var _useState6 = useState(rtmStatusEnum.offline),\n    rtmStatus = _useState6[0],\n    setRtmStatus = _useState6[1];\n  var _useContext3 = useContext(RtcContext),\n    rtcUid = _useContext3.localUid,\n    localAudioTrack = _useContext3.localAudioTrack,\n    localVideoTrack = _useContext3.localVideoTrack,\n    dispatch = _useContext3.dispatch,\n    channelJoined = _useContext3.channelJoined;\n  var login = function login() {\n    try {\n      var tokenUrl = rtcProps.tokenUrl;\n      var _temp4 = function () {\n        if (tokenUrl) {\n          var _temp5 = _catch(function () {\n            return Promise.resolve(fetch(tokenUrl + '/rtm/' + ((rtmProps === null || rtmProps === void 0 ? void 0 : rtmProps.uid) || localUid.current))).then(function (res) {\n              return Promise.resolve(res.json()).then(function (data) {\n                var serverToken = data.rtmToken;\n                return Promise.resolve(rtmClient.login({\n                  uid: (rtmProps === null || rtmProps === void 0 ? void 0 : rtmProps.uid) || localUid.current,\n                  token: serverToken\n                })).then(function () {\n                  timerValueRef.current = 5;\n                });\n              });\n            });\n          }, function () {\n            setTimeout(function () {\n              try {\n                timerValueRef.current = timerValueRef.current + timerValueRef.current;\n                login();\n                return Promise.resolve();\n              } catch (e) {\n                return Promise.reject(e);\n              }\n            }, timerValueRef.current * 1000);\n          });\n          if (_temp5 && _temp5.then) return _temp5.then(function () {});\n        } else {\n          var _temp6 = _catch(function () {\n            return Promise.resolve(rtmClient.login({\n              uid: (rtmProps === null || rtmProps === void 0 ? void 0 : rtmProps.uid) || localUid.current,\n              token: (rtmProps === null || rtmProps === void 0 ? void 0 : rtmProps.token) || undefined\n            })).then(function () {\n              timerValueRef.current = 5;\n            });\n          }, function () {\n            setTimeout(function () {\n              try {\n                timerValueRef.current = timerValueRef.current + timerValueRef.current;\n                login();\n                return Promise.resolve();\n              } catch (e) {\n                return Promise.reject(e);\n              }\n            }, timerValueRef.current * 1000);\n          });\n          if (_temp6 && _temp6.then) return _temp6.then(function () {});\n        }\n      }();\n      return Promise.resolve(_temp4 && _temp4.then ? _temp4.then(function () {}) : void 0);\n    } catch (e) {\n      return Promise.reject(e);\n    }\n  };\n  var joinChannel = function joinChannel() {\n    try {\n      var _temp8 = _catch(function () {\n        return Promise.resolve(channel.join()).then(function () {\n          timerValueRef.current = 5;\n        });\n      }, function () {\n        setTimeout(function () {\n          try {\n            timerValueRef.current = timerValueRef.current + timerValueRef.current;\n            joinChannel();\n            return Promise.resolve();\n          } catch (e) {\n            return Promise.reject(e);\n          }\n        }, timerValueRef.current * 1000);\n      });\n      return Promise.resolve(_temp8 && _temp8.then ? _temp8.then(function () {}) : void 0);\n    } catch (e) {\n      return Promise.reject(e);\n    }\n  };\n  var init = function init() {\n    try {\n      setRtmStatus(rtmStatusEnum.initialising);\n      rtcProps.uid ? localUid.current = String(rtcProps.uid) : localUid.current = String(timeNow());\n      rtmClient.on('ConnectionStateChanged', function (state, reason) {\n        console.log(state, reason);\n      });\n      rtmClient.on('TokenExpired', function () {\n        try {\n          var tokenUrl = rtcProps.tokenUrl;\n          console.log('token expired - renewing');\n          var _temp11 = function () {\n            if (tokenUrl) {\n              var _temp12 = _catch(function () {\n                return Promise.resolve(fetch(tokenUrl + '/rtm/' + ((rtmProps === null || rtmProps === void 0 ? void 0 : rtmProps.uid) || localUid.current))).then(function (res) {\n                  return Promise.resolve(res.json()).then(function (data) {\n                    var serverToken = data.rtmToken;\n                    return Promise.resolve(rtmClient.renewToken(serverToken)).then(function () {\n                      timerValueRef.current = 5;\n                    });\n                  });\n                });\n              }, function (error) {\n                console.error('TokenExpiredError', error);\n              });\n              if (_temp12 && _temp12.then) return _temp12.then(function () {});\n            }\n          }();\n          return Promise.resolve(_temp11 && _temp11.then ? _temp11.then(function () {}) : void 0);\n        } catch (e) {\n          return Promise.reject(e);\n        }\n      });\n      rtmClient.on('MessageFromPeer', function (message, peerId) {\n        handleReceivedMessage(message, peerId);\n      });\n      channel.on('ChannelMessage', function (message, peerId) {\n        handleReceivedMessage(message, peerId);\n      });\n      channel.on('MemberJoined', function (peerId) {\n        try {\n          return Promise.resolve(sendPeerMessage(createUserData(), peerId)).then(function () {});\n        } catch (e) {\n          return Promise.reject(e);\n        }\n      });\n      channel.on('MemberCountUpdated', function (count) {\n        try {\n          console.log('RTM-MemberCountUpdated: ', count);\n          return Promise.resolve();\n        } catch (e) {\n          return Promise.reject(e);\n        }\n      });\n      if (rtmCallbacks !== null && rtmCallbacks !== void 0 && rtmCallbacks.channel) {\n        Object.keys(rtmCallbacks.channel).map(function (callback) {\n          if (rtmCallbacks.channel) {\n            channel.on(callback, rtmCallbacks.channel[callback]);\n          }\n        });\n      } else if (rtmCallbacks !== null && rtmCallbacks !== void 0 && rtmCallbacks.client) {\n        Object.keys(rtmCallbacks.client).map(function (callback) {\n          if (rtmCallbacks.client) {\n            rtmClient.on(callback, rtmCallbacks.client[callback]);\n          }\n        });\n      }\n      if (rtcProps.tokenUrl) {\n        var tokenUrl = rtcProps.tokenUrl,\n          uid = rtcProps.uid;\n        rtmClient.on('TokenExpired', function () {\n          try {\n            console.log('token expired');\n            return Promise.resolve(fetch(tokenUrl + '/rtm/' + (uid || 0) + '/')).then(function (res) {\n              return Promise.resolve(res.json()).then(function (data) {\n                var token = data.rtmToken;\n                rtmClient.renewToken(token);\n              });\n            });\n          } catch (e) {\n            return Promise.reject(e);\n          }\n        });\n      }\n      setRtmStatus(rtmStatusEnum.loggingIn);\n      return Promise.resolve(login()).then(function () {\n        setRtmStatus(rtmStatusEnum.loggedIn);\n        return Promise.resolve(joinChannel()).then(function () {\n          setRtmStatus(rtmStatusEnum.connected);\n          setUsernames(function (p) {\n            return _extends({}, p, {\n              0: rtmProps === null || rtmProps === void 0 ? void 0 : rtmProps.username\n            });\n          });\n          sendChannelMessage(createUserData());\n        });\n      });\n    } catch (e) {\n      return Promise.reject(e);\n    }\n  };\n  var createUserData = function createUserData() {\n    return {\n      messageType: 'UserData',\n      rtmId: (rtmProps === null || rtmProps === void 0 ? void 0 : rtmProps.uid) || localUid.current,\n      rtcId: rtcUid.current,\n      username: rtmProps === null || rtmProps === void 0 ? void 0 : rtmProps.username,\n      role: rtcProps.role === 'audience' ? 1 : 0,\n      uikit: {\n        platform: 'web',\n        framework: 'react',\n        version: '1.2.0'\n      },\n      agora: {\n        rtm: AgoraRTM.VERSION,\n        rtc: AgoraRTC.VERSION\n      }\n    };\n  };\n  var sendMuteRequest = function sendMuteRequest(device, rtcId, mute) {\n    var forced = (rtmProps === null || rtmProps === void 0 ? void 0 : rtmProps.showPopUpBeforeRemoteMute) === false;\n    var payload = {\n      messageType: 'MuteRequest',\n      device: device,\n      rtcId: rtcId,\n      mute: mute,\n      isForceful: forced\n    };\n    var peerId = uidMap[rtcId];\n    if (forced && !mute) {\n      console.log('cannot send force unmute request');\n    } else if (peerId) {\n      sendPeerMessage(payload, peerId);\n    } else {\n      console.log('peer not found');\n    }\n  };\n  var handleReceivedMessage = function handleReceivedMessage(message, peerId) {\n    var messageObject;\n    if (message.messageType === 'RAW') {\n      messageObject = parsePayload(message.rawMessage);\n    } else if (message.messageType === 'TEXT') {\n      messageObject = JSON.parse(message.text);\n    }\n    console.log(messageObject, peerId);\n    if (messageObject) {\n      switch (messageObject.messageType) {\n        case 'UserData':\n          handleReceivedUserDataMessage(messageObject);\n          break;\n        case 'MuteRequest':\n          handleReceivedMuteMessage(messageObject);\n          break;\n        case 'RtmDataRequest':\n          switch (messageObject.type) {\n            case 'ping':\n              handlePing(peerId);\n              break;\n            case 'userData':\n              handleUserDataRequest(peerId);\n              break;\n            default:\n              console.log(peerId);\n          }\n          break;\n        default:\n          console.log('unknown message content');\n      }\n    } else {\n      console.log('unknown rtm message type');\n    }\n  };\n  var handleReceivedUserDataMessage = function handleReceivedUserDataMessage(userData) {\n    setUidMap(function (p) {\n      var _extends2;\n      return _extends({}, p, (_extends2 = {}, _extends2[userData.rtcId] = userData.rtmId, _extends2));\n    });\n    setUsernames(function (p) {\n      var _extends3;\n      return _extends({}, p, (_extends3 = {}, _extends3[userData.rtcId] = userData.username, _extends3));\n    });\n    setUserDataMap(function (p) {\n      var _extends4;\n      return _extends({}, p, (_extends4 = {}, _extends4[userData.rtmId] = userData, _extends4));\n    });\n  };\n  var handleReceivedMuteMessage = function handleReceivedMuteMessage(muteRequest) {\n    if (rtcUid.current === muteRequest.rtcId) {\n      if (muteRequest.isForceful) {\n        if (muteRequest.mute) {\n          if (muteRequest.device === mutingDevice.microphone) {\n            localAudioTrack && muteAudio(local, dispatch, localAudioTrack);\n          } else if (muteRequest.device === mutingDevice.camera) {\n            localVideoTrack && muteVideo(local, dispatch, localVideoTrack);\n          }\n        } else console.error('cannot force unmute');\n      } else {\n        if (muteRequest.device === mutingDevice.microphone) {\n          if (muteRequest.mute) setPopUpState(popUpStateEnum.muteMic);else setPopUpState(popUpStateEnum.unmuteMic);\n        } else if (muteRequest.device === mutingDevice.camera) {\n          if (muteRequest.mute) setPopUpState(popUpStateEnum.muteCamera);else setPopUpState(popUpStateEnum.unmuteCamera);\n        }\n      }\n    }\n  };\n  var handlePing = function handlePing(peerId) {\n    sendPeerMessage({\n      messageType: 'RtmDataRequest',\n      type: 'pong'\n    }, peerId);\n  };\n  var handleUserDataRequest = function handleUserDataRequest(peerId) {\n    sendPeerMessage(createUserData(), peerId);\n  };\n  var sendChannelMessage = function sendChannelMessage(payload) {\n    try {\n      var message = rtmClient.createMessage({\n        text: JSON.stringify(payload),\n        messageType: AgoraRTM.MessageType.TEXT\n      });\n      var _temp14 = _catch(function () {\n        return Promise.resolve(channel.sendMessage(message)).then(function () {});\n      }, function (e) {\n        console.error(e);\n      });\n      return Promise.resolve(_temp14 && _temp14.then ? _temp14.then(function () {}) : void 0);\n    } catch (e) {\n      return Promise.reject(e);\n    }\n  };\n  var sendPeerMessage = function sendPeerMessage(payload, peerId) {\n    try {\n      var message = rtmClient.createMessage({\n        text: JSON.stringify(payload),\n        messageType: AgoraRTM.MessageType.TEXT\n      });\n      var _temp16 = _catch(function () {\n        return Promise.resolve(rtmClient.sendMessageToPeer(message, String(peerId))).then(function () {});\n      }, function (e) {\n        console.error(e);\n      });\n      return Promise.resolve(_temp16 && _temp16.then ? _temp16.then(function () {}) : void 0);\n    } catch (e) {\n      return Promise.reject(e);\n    }\n  };\n  var end = function end() {\n    try {\n      return Promise.resolve(rtmClient.logout()).then(function () {\n        return Promise.resolve(rtmClient.removeAllListeners()).then(function () {});\n      });\n    } catch (e) {\n      return Promise.reject(e);\n    }\n  };\n  useEffect(function () {\n    if (channelJoined) {\n      init();\n      setLoggedIn(true);\n    }\n    return function () {\n      if (channelJoined) {\n        end();\n      }\n    };\n  }, [rtcProps.channel, rtcProps.appId, channelJoined]);\n  return React.createElement(RtmProvider, {\n    value: {\n      rtmStatus: rtmStatus,\n      sendPeerMessage: sendPeerMessage,\n      sendChannelMessage: sendChannelMessage,\n      sendMuteRequest: sendMuteRequest,\n      rtmClient: rtmClient,\n      uidMap: uidMap,\n      usernames: usernames,\n      userDataMap: userDataMap,\n      popUpState: popUpState,\n      setPopUpState: setPopUpState\n    }\n  }, isLoggedIn ? props.children : React.createElement(React.Fragment, null));\n};\nvar enc = new TextEncoder();\nvar dec = new TextDecoder();\nvar createRawMessage = function createRawMessage(msg) {\n  return enc.encode(JSON.stringify(msg));\n};\nvar parsePayload = function parsePayload(data) {\n  return JSON.parse(dec.decode(data));\n};\nfunction PopUp() {\n  var _useContext = useContext(PropsContext),\n    styleProps = _useContext.styleProps;\n  var _useContext2 = useContext(RtmContext),\n    popUpState = _useContext2.popUpState,\n    setPopUpState = _useContext2.setPopUpState;\n  var _ref = styleProps || {},\n    popUpContainer = _ref.popUpContainer;\n  var _useContext3 = useContext(RtcContext),\n    dispatch = _useContext3.dispatch,\n    localVideoTrack = _useContext3.localVideoTrack,\n    localAudioTrack = _useContext3.localAudioTrack;\n  var local = useContext(LocalContext);\n  return popUpState !== popUpStateEnum.closed ? React.createElement(\"div\", {\n    style: _extends({}, styles$3.container, popUpContainer)\n  }, React.createElement(\"div\", {\n    style: {\n      color: '#fff',\n      fontSize: 18,\n      fontWeight: 700\n    }\n  }, popUpState === popUpStateEnum.muteCamera || popUpState === popUpStateEnum.muteMic ? 'Mute ' : 'Unmute ', popUpState === popUpStateEnum.muteCamera || popUpState === popUpStateEnum.unmuteCamera ? 'Camera' : 'Mic', \"?\"), React.createElement(\"div\", {\n    style: {\n      flexDirection: 'row',\n      display: 'flex',\n      width: '100%',\n      justifyContent: 'space-around'\n    }\n  }, React.createElement(\"div\", {\n    onClick: function onClick() {\n      switch (popUpState) {\n        case popUpStateEnum.muteCamera:\n          local.hasVideo && localVideoTrack && muteVideo(local, dispatch, localVideoTrack);\n          break;\n        case popUpStateEnum.muteMic:\n          local.hasAudio && localAudioTrack && muteAudio(local, dispatch, localAudioTrack);\n          break;\n        case popUpStateEnum.unmuteCamera:\n          !local.hasVideo && localVideoTrack && muteVideo(local, dispatch, localVideoTrack);\n          break;\n        case popUpStateEnum.unmuteMic:\n          !local.hasAudio && localAudioTrack && muteAudio(local, dispatch, localAudioTrack);\n          break;\n      }\n      setPopUpState(popUpStateEnum.closed);\n    },\n    style: styles$3.button\n  }, \"Confirm\"), React.createElement(\"div\", {\n    style: styles$3.buttonClose,\n    onClick: function onClick() {\n      return setPopUpState(popUpStateEnum.closed);\n    }\n  }, \"Close\"))) : null;\n}\nvar styles$3 = {\n  button: {\n    color: '#fff',\n    cursor: 'pointer',\n    borderWidth: 2,\n    borderStyle: 'solid',\n    borderColor: '#fff',\n    padding: '2px 4px',\n    borderRadius: 4\n  },\n  buttonClose: {\n    color: '#fff',\n    cursor: 'pointer',\n    borderWidth: 2,\n    borderStyle: 'solid',\n    borderColor: '#fff',\n    padding: '2px 4px',\n    borderRadius: 4\n  },\n  container: {\n    backgroundColor: '#007bffaa',\n    position: 'absolute',\n    width: 240,\n    height: 80,\n    top: '50%',\n    left: '50%',\n    transform: 'translate(-50%, -50%)',\n    zIndex: 100,\n    display: 'flex',\n    flexDirection: 'column',\n    justifyContent: 'space-evenly',\n    alignItems: 'center'\n  }\n};\nvar AgoraUIKit = function AgoraUIKit(props) {\n  var styleProps = props.styleProps,\n    rtcProps = props.rtcProps;\n  var _ref = styleProps || {},\n    UIKitContainer = _ref.UIKitContainer;\n  return React.createElement(PropsProvider, {\n    value: props\n  }, React.createElement(\"div\", {\n    style: _extends({}, style$1, UIKitContainer)\n  }, rtcProps.role === 'audience' ? React.createElement(VideocallUI, null) : React.createElement(TracksConfigure, null, React.createElement(VideocallUI, null))));\n};\nvar VideocallUI = function VideocallUI() {\n  var _useContext = useContext(PropsContext),\n    rtcProps = _useContext.rtcProps;\n  return React.createElement(RtcConfigure, {\n    callActive: rtcProps.callActive\n  }, React.createElement(LocalUserContext, null, rtcProps.disableRtm ? React.createElement(React.Fragment, null, (rtcProps === null || rtcProps === void 0 ? void 0 : rtcProps.layout) === layout.grid ? React.createElement(GridVideo, null) : React.createElement(PinnedVideo, null), React.createElement(LocalControls, null)) : React.createElement(RtmConfigure, null, React.createElement(PopUp, null), (rtcProps === null || rtcProps === void 0 ? void 0 : rtcProps.layout) === layout.grid ? React.createElement(GridVideo, null) : React.createElement(PinnedVideo, null), React.createElement(LocalControls, null))));\n};\nvar style$1 = {\n  display: 'flex',\n  flex: 1,\n  minHeight: 0,\n  flexDirection: 'column'\n};\nexport default AgoraUIKit;\nexport { BtnTemplate, EndCall, GridVideo, LocalAudioMute, LocalControls, LocalUserContext, LocalVideoMute, MaxUidContext, MaxVideoView, MinUidContext, MinVideoView, PinnedVideo, PropsContext, RemoteAudioMute, PopUp as RemoteMutePopUp, RemoteVideoMute, RtcConfigure, RtcConsumer, RtcContext, RtcProvider, RtmConfigure, RtmConsumer, RtmContext, RtmProvider, SwapUser, ToggleState, TracksConfigure, TracksContext, VideoPlaceholder, VideocallUI, createRawMessage, icons, layout, muteAudio, muteVideo, mutingDevice, parsePayload, popUpStateEnum, rtmStatusEnum };","map":null,"metadata":{},"sourceType":"module"}